---
- name: Register JAR file
  ansible.builtin.stat:
    path: "{{ remote_deploy_path }}/{{ module_name }}.jar"
  register: jar_file
  tags:
    - init
    - deploy

- name: Check JAR file exists
  block:
    - name: Fail and print message
      ansible.builtin.fail:
        msg: "{{ module_name }}.jar does not exist"
      when: not jar_file.stat.exists

    - name: Print success message
      ansible.builtin.debug:
        msg: "{{ module_name }}.jar exists!!"
  tags:
    - init
    - deploy

- name: Copy JAR file for running application
  ansible.builtin.copy:
    src: "{{ remote_deploy_path }}/{{ module_name }}.jar"
    remote_src: yes
    dest: "{{ remote_app_path }}/{{ module_name }}.jar"
    owner: "{{ remote_server_user }}"
    group: "{{ remote_server_group }}"
    mode: 0644
  tags:
    - init
    - deploy

- name: Remove deployed JAR file
  ansible.builtin.file:
    state: absent
    path: "{{ remote_deploy_path }}/{{ module_name }}.jar"
  tags:
    - init
    - deploy

- name: [Rolling Update] Copy service script file to remote server
  ansible.builtin.template:
    src: rolling-deploy.sh.j2
    dest: "{{ remote_app_path }}/service.sh"
    owner: "{{ remote_server_user }}"
    group: "{{ remote_server_group }}"
    mode: 0755
  tags:
    - rolling_update

- name: [Rolling Update] Run service script
  ansible.builtin.include_tasks:
    file: _rolling_update.yml
    apply:
      tags:
        - rolling_update
  loop:
    - 8080
    - 8081
  tags:
    - rolling_update

- name: [Blue Green] Copy service script file to remote server
  ansible.builtin.template:
    src: blue-green-deploy.sh.j2
    dest: "{{ remote_app_path }}/service.sh"
    owner: "{{ remote_server_user }}"
    group: "{{ remote_server_group }}"
    mode: 0755
  tags:
    - blue_green

- name: [Blue Green] Run service script
  ansible.builtin.include_tasks:
    file: _blue_green.yml
    apply:
      tags:
        - blue_green
  tags:
    - blue_green

- name: Finish
  ansible.builtin.debug:
    msg: "All tasks completed!!"
  tags:
    - init
    - deploy
