#!/bin/bash

# prevent from multiple running
SHELL_SCRIPT=$(basename "$0")
PROCESS_SHELL_COUNT=$(pgrep -c "${SHELL_SCRIPT}")
if [ "$PROCESS_SHELL_COUNT" -gt 1 ]; then
    echo -e "not allowed to run multiple..."
    exit 10
fi

APP_WORKSPACE="{{ remote_app_path }}"
MODULE_NAME="{{ module_name }}"
PORT=$1

# nginx proxy
PROXY_CONF_FILE=/etc/nginx/conf.d/${MODULE_NAME}.conf
PROXY_TARGET_UPSTREAM="server 127.0.0.1:${PORT}"

# app
SPRING_PROFILE="{{ spring_profile }}"
STD_OUT=${APP_WORKSPACE}/logs/stdout_${PORT}.log
STD_ERR=${APP_WORKSPACE}/logs/stderr_${PORT}.log

# port
BLUE=${APP_WORKSPACE}/BLUE
GREEN=${APP_WORKSPACE}/GREEN

func_get_target_ports_or_default() {
  local group_file=$1
  local group_name=$2
  local -n return_ports=$3  # nameref

  local default_ports
  if [ "$group_name" == "BLUE" ];
  then
    default_ports=(8080 8081)
  else
    default_ports=(8082 8083)
  fi

  readarray -t return_ports < "$group_file"
  if [ ${#return_ports[@]} -ne 0 ];
  then
    printf "$group_name: "
    printf "%s\n" "${return_ports[@]}"
  else
    return_ports=("${default_ports[@]}")
  fi
}

# param: BLUE or GREEN
func_check_target_ports_group() {
  local target_ports_file=$1
  local target_group_name
  target_group_name=$(basename "$target_ports_file")
  echo "-----------------------------------------"
  echo "[CHECK $target_group_name PORTS]"
  echo "-----------------------------------------"

  # create file if not exists
  touch "$target_ports_file"

  local target_ports
  func_get_target_ports_or_default "$target_ports_file" "$target_group_name" target_ports

  for port in "${PORT_NUMBERS[@]}";
  do
    current_pid=$(pgrep -f "java.*${port}")
    if [ -z "${current_pid}" ];
    then
      echo "no current running application >> pass killing process"
    else
      sleep 2
    fi
  done
}

# toggle proxy upstream status (up, down)
func_toggle_proxy_upstream() {
  local toggle_status
  toggle_status=$1

  local from_upstream_status  # regex
  local to_upstream_status
  case ${toggle_status} in
    up)
      from_upstream_status="${PROXY_TARGET_UPSTREAM}\sdown;"
      to_upstream_status="${PROXY_TARGET_UPSTREAM};"
      ;;
    down)
      from_upstream_status="${PROXY_TARGET_UPSTREAM};"
      to_upstream_status="${PROXY_TARGET_UPSTREAM} down;"
      ;;
    *)
      # TODO 취약점
      # 만약 중간에 exit 되고 이미 적용된 upstream이 있는 경우 upstream간에 버전 불일치 발생 가능
      echo "[func_toggle_proxy_upstream] Invalid command - ${toggle_status}"
      exit 40;
      ;;
  esac

  echo ">> proxy upstream ${PORT} ${toggle_status}"
  target_upstream_status=$(grep "${to_upstream_status}" "${PROXY_CONF_FILE}")
  if [ -n "${target_upstream_status}" ]
  then
    echo "proxy upstream ${PORT} status - already ${toggle_status}"
  else
    echo "proxy upstream ${PORT} setting ${toggle_status}"
    sudo sed -i "s/\(${from_upstream_status}\)/${to_upstream_status}/g" "${PROXY_CONF_FILE}"
  fi

  if ! sudo nginx -t;
  then
    echo "Invalid nginx conf > upstream(${PORT}}) ${toggle_status}"
    exit 40
  fi

  sudo systemctl reload nginx
}

# health check application
CHECK_MAX_COUNT=10
CHECK_COUNT=0
func_app_health_check() {
  if [ $CHECK_COUNT -gt $CHECK_MAX_COUNT ];
  then
    echo "Failure of running java application(${PORT})"
    exit 50
  fi

  status_code=$(curl --connect-timeout 1 --max-time 3 -i -X GET http://localhost:"${PORT}"/monitoring/health | awk '/HTTP\/1/{print $2}')
  if [[ $status_code =~ ^2[0-9]{2}$ ]];
  then
    echo "application(${PORT}) health check > UP"
  else
    echo "application(${PORT}) health check > DOWN"
    sleep 3
    CHECK_COUNT=$(expr ${CHECK_COUNT} + 1)
    func_app_health_check
  fi
}

# shutdown application
shutdown() {
  echo "-----------------------------------------"
  echo "[SHUTDOWN] ${MODULE_NAME}:${PORT}"
  echo "-----------------------------------------"

  func_toggle_proxy_upstream down

  echo ">> kill current running application(${PORT})"
  current_pid=$(pgrep -f "java.*${PORT}")
  if [ -z "${current_pid}" ];
  then
    echo "no current running application >> pass killing process"
  else
    echo "stop java application(${PORT}) - ${current_pid}"
    sudo kill -TERM "${current_pid}"
    sleep 2
  fi
}

# run application
run_app() {
  echo "-----------------------------------------"
  echo "[RUN_APP] ${MODULE_NAME}:${PORT}"
  echo "-----------------------------------------"

  cd "${APP_WORKSPACE}" || exit 40

  echo ">> run java application"
  if ! java --version;
  then
    echo "no JRE setup > JRE is required!!"
    exit 50
  fi

  nohup java -jar \
    -Dspring.profiles.active="${SPRING_PROFILE}" \
    -Dserver.port="${PORT}" \
    "${APP_WORKSPACE}"/"${MODULE_NAME}".jar 1>"${STD_OUT}" 2>"${STD_ERR}" &

  echo ">> application(${PORT}) health check"
  func_app_health_check

  func_toggle_proxy_upstream up
}

main() {
  shutdown
  run_app

  echo "## run application completed!!"
}

main
